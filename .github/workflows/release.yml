name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: google-github-actions/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          release-type: simple

  build-release:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Xcode
      run: |
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        xcodebuild -version

    - name: Install QEMU for testing
      run: brew install qemu

    - name: Run environment detection
      run: ./scripts/detect-env.sh

    - name: Fetch sources
      run: ./scripts/fetch-sources.sh

    - name: Configure build
      run: ./scripts/configure-build.sh

    - name: Build kernel
      run: ./scripts/build-kernel.sh

    - name: Run complete build test
      run: ./scripts/build-all.sh

    - name: Test VM script (dry run)
      run: timeout 10s ./scripts/test-vm.sh || echo "VM test timed out as expected"

    - name: Validate build artifacts
      run: |
        ls -la output/arm64/
        if [ -f output/arm64/kernel ]; then
          file output/arm64/kernel
          echo "Kernel artifact exists"
        else
          echo "No kernel artifact found"
          exit 1
        fi

    - name: Create Release Archive
      run: |
        tar -czf xnu-build-${{ needs.release-please.outputs.tag_name }}.tar.gz \
          --exclude='.git' \
          --exclude='sources' \
          --exclude='build' \
          --exclude='output' \
          --exclude='BUILD_CONFIG.env' \
          .

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.release-please.outputs.tag_name }}
        files: ./xnu-build-${{ needs.release-please.outputs.tag_name }}.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}