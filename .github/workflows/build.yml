name: Build and Test XNU Kernel

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  test-scripts:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install actionlint
      run: |
        brew install actionlint

    - name: Validate GitHub Actions workflows
      run: |
        actionlint .github/workflows/*.yml
        echo "Workflows are valid"

    - name: Validate shell scripts
      run: |
        find scripts/ -name "*.sh" -exec bash -n {} \;
        echo "All scripts are syntactically valid"

    - name: Check study guides exist
      run: |
        ls -la MACH_*.md BSD_*.md IOKIT_*.md XNU_*.md
        echo "Study guides are present"

    - name: Test fetch-sources help
      run: ./scripts/fetch-sources.sh --help

    - name: Test build-kernel help
      run: ./scripts/build-kernel.sh --help

  build:
    runs-on: macos-latest
    strategy:
      matrix:
        xcode: [latest]
        include:
          - xcode: latest
            path: /Applications/Xcode.app/Contents/Developer
    steps:
    - uses: actions/checkout@v4

    - name: Set up Xcode ${{ matrix.xcode }}
      run: |
        sudo xcode-select -s ${{ matrix.path }}
        xcodebuild -version

    - name: Install QEMU for testing
      run: brew install qemu

    - name: Run environment detection
      run: ./scripts/detect-env.sh

    - name: Fetch sources
      run: ./scripts/fetch-sources.sh

    - name: Configure build
      run: ./scripts/configure-build.sh

    - name: Build kernel
      run: ./scripts/build-kernel.sh

    - name: Run complete build test
      run: ./scripts/build-all.sh

    - name: Test VM script (dry run)
      run: timeout 10s ./scripts/test-vm.sh || echo "VM test timed out as expected"

    - name: Validate build artifacts
      run: |
        ls -la output/arm64/
        if [ -f output/arm64/kernel ]; then
          file output/arm64/kernel
          echo "Kernel artifact exists"
        else
          echo "No kernel artifact found"
          exit 1
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: xnu-kernel-artifacts-${{ matrix.xcode }}
        path: |
          output/
          build/build.log
          BUILD_CONFIG.env

  test-sources:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Xcode
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

    - name: Run environment detection
      run: ./scripts/detect-env.sh

    - name: Force fetch sources
      run: ./scripts/fetch-sources.sh --force

    - name: Verify source integrity
      run: |
        find sources/ -name "*.c" -o -name "*.cpp" -o -name "*.h" | wc -l
        echo "Sources contain C/C++ files"

    - name: Check XNU structure
      run: |
        ls sources/xnu/osfmk sources/xnu/bsd sources/xnu/iokit sources/xnu/libkern
        echo "XNU structure is correct"

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Create Release Archive
      run: |
        tar -czf xnu-build-${{ github.ref_name }}.tar.gz \
          --exclude='.git' \
          --exclude='sources' \
          --exclude='build' \
          --exclude='output' \
          --exclude='BUILD_CONFIG.env' \
          .

    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        body: |
          ## XNU Build System ${{ github.ref_name }}

          Automated release of the XNU kernel build system.

          ### What's Included
          - Complete build scripts and automation
          - Study guides and documentation
          - CI/CD configuration
          - VM testing tools

          ### Installation
          ```bash
          git clone https://github.com/bniladridas/xnu-build.git
          cd xnu-build
          ./scripts/build-all.sh
          ```

          ### Notes
          - Educational and VM testing only
          - Requires macOS for full functionality
          - See README.md for detailed usage
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./xnu-build-${{ github.ref_name }}.tar.gz
        asset_name: xnu-build-${{ github.ref_name }}.tar.gz
        asset_content_type: application/gzip